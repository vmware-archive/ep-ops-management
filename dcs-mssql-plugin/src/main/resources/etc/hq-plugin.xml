<?xml version="1.0"?>
<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".

  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.

  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.

 You should have received a copy of the GNU General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
 USA.
-->

<plugin name="mssql">
    <property name="PLUGIN_VERSION" value="@project.version@"/>
    <script name="MDF_FreeSpacePct2005.sql">
	<![CDATA[
DECLARE @DBInfo TABLE (
	DatabaseName VARCHAR(100),
	FileSizeMB DECIMAL(38,5),
	FreeSpaceMB DECIMAL(38,5)
)

DECLARE @command VARCHAR(5000)

SELECT @command = '
Use [?]
SELECT
	''?'' AS DatabaseName,
	CAST(sysfiles.size/128.0 AS DECIMAL(38,5)) AS FileSize,
	CAST(sysfiles.size/128.0 - CAST(FILEPROPERTY(sysfiles.name, ''SpaceUsed'' ) AS DECIMAL(38,5))/128.0 AS DECIMAL(38,5)) AS FreeSpaceMB
FROM dbo.sysfiles
'

INSERT INTO @DBInfo (DatabaseName, FileSizeMB, FreeSpaceMB)
EXEC sp_MSForEachDB @command

SELECT
   DatabaseName,
   sum(FileSizeMB),
   sum(FreeSpaceMB),
   (sum(FreeSpaceMB) / sum(FileSizeMB)) * 100 as free
FROM @DBInfo
group by DatabaseName
	]]>
    </script>

    <!-- Script for version 2000 -->
    <script name="MDF_FreeSpacePct2000.sql">
	<![CDATA[
set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
IF OBJECT_ID('tempdb..#tTables') IS NOT NULL DROP TABLE #tTables
create table #tTables
(
numID INTEGER IDENTITY(1,1),
strTableName sysname,
db_sizes bigint,
unalloc_sizes bigint
)
EXEC sp_MSforeachdb
'USE [?]
declare @dbname sysname
declare @bytesperpage dec(15,0)
declare @pagesperMB dec(15,0)
declare @dbmaxsize dec(15,0)
SET @dbname = db_name()
select @bytesperpage = low from master.dbo.spt_values where number = 1 and type = ''E''
select @pagesperMB = 1048576 / @bytesperpage
select @dbmaxsize = min(maxsize) from dbo.sysfiles where (status & 64 = 0)
if @dbmaxsize <> -1
begin
select @dbmaxsize = sum(convert(dec(15),maxsize)) from dbo.sysfiles where (status & 64 = 0)
end

insert into #tTables( strTableName, db_sizes, unalloc_sizes)
select
db_name(),
database_size =  (case @dbmaxsize when -1 then -1 else	cast( ((@dbmaxsize / @pagesperMB)*1024) as bigint ) end),
unallocated_space =  cast((((@dbmaxsize - (select sum(convert(dec(15),reserved) )
from sysindexes where indid in (0, 1, 255))) / @pagesperMB )*1024) as bigint )'

select strTableName "DBName",
(case db_sizes when -1 then 100 else CAST(ROUND(100.0*unalloc_sizes/db_sizes, 0) AS INT) end) "DatabaseFreePct" from #tTables

drop table #tTables
	]]>
    </script>

    <!-- appended to each template by the hq-plugin.xml parser -->
    <property name="template-config"
              value="service_name=%service_name%,pref_prefix=%pref_prefix%,MSRS=%MSRS%,instance=%instance%"/>

    <filter name="cache.domain"
            value="Cache Manager(${cache.name})"/>

    <filter name="template" value="collector:sn=%service_name%,t=bfc:${name}:g=Buffer Manager"/>
    <metrics name="Buffer-Manager_c">
        <metric name="Page lookups/sec"/>
        <metric name="Free list stalls/sec"/>
        <metric name="Lazy writes/sec" indicator="true"/>
        <metric name="Readahead pages/sec"/>
        <metric name="Page reads/sec"/>
        <metric name="Page writes/sec"/>
        <metric name="Checkpoint pages/sec"/>
    </metrics>

    <filter name="template" value="pdh:Buffer Manager:${name}"/>
    <metrics name="Buffer-Manager" include="Buffer-Manager_c">
        <metric name="Buffer cache hit ratio" units="percent" indicator="true"/>
        <metric name="Database pages"/>
        <metric name="Page life expectancy"  indicator="true"/>
    </metrics>

    <filter name="template" value="pdh:Buffer Manager:${name}"/>
    <metrics name="Buffer-Manager_2012">
        <metric name="Integral Controller Slope"/>
        <metric name="Background writer pages/sec" template="collector:sn=%service_name%,t=bfm:${name}:g=Buffer Manager"/>
    </metrics>
    <metrics name="mssql-avail">
        <metric name="Availability" alias="Availability" template="service:Type=Availability,service_name=%service_name%,testdbcon=true,sqlserver_name=%sqlserver_name%,instance=%instance-name%:${alias}" indicator="true" category="AVAILABILITY"/>
        <metric name="Instance uptime" template="query:sqlserver_name=%sqlserver_name%,instance=%instance-name%:uptime" units="sec" indicator="true"/>
   </metrics>

    <filter name="template" value="collector:sn=%service_name%,type=Database:${name}:g=Databases(%db.name%)"/>
    <metrics name="mssql-database_c">
        <metric name="Transactions/sec" category="THROUGHPUT" indicator="true"/>
        <metric name="Repl. Trans. Rate"/>
        <metric name="Repl. Pending Xacts"/>
        <metric name="Log Flush Wait Time"/>
    </metrics>

    <filter name="template" value="pdh:Databases(%db.name%):${name}"/>
    <metrics name="mssql-database">
        <include name="mssql-database_c"/>
        <metric name="Availability" alias="Availability" template="pdhDBAvail:Type=Availability,db.name=%db.name%:${alias}" indicator="true" category="AVAILABILITY"/>
        <metric name="Data File Size" template="pdh:Databases(%db.name%):Data File(s) Size (KB)" indicator="true" units="KB"/>
        <metric name="Log File Size" template="pdh:Databases(%db.name%):Log File(s) Size (KB)" units="KB"/>
        <metric name="Log File Used Size" template="pdh:Databases(%db.name%):Log File(s) Used Size (KB)" units="KB"/>
        <metric name="Percent Log Used" units="percent"/>
        <metric name="Active Transactions" category="THROUGHPUT" indicator="true"/>
        <metric name="Log Cache Hit Ratio"/>
        <metric name="Log Truncations"/>
        <metric name="Log Growths"/>
        <metric name="Log Shrinks"/>
        <metric name="Data File Disk % Free Space" template="pdh2:LogicalDisk(%disk%):%% Free Space" units="percent" indicator="true"/>
        <metric name="Data File Disk Free Space" template="pdh2:LogicalDisk(%disk%):Free Megabytes" units="MB" indicator="true"/>
        <metric name="Data File next Allocation" template="query:file=%master.file%,sqlserver_name=%sqlserver_name%,instance=%instance%:alloc" units="KB" indicator="true"/>
        <metric name="Data File Max Size" template="query:file=%master.file%,sqlserver_name=%sqlserver_name%,instance=%instance%:max_size" units="KB" defaultOn="true"/>
        <metric name="Recovery Model" template="query:db.name=%db.name%,sqlserver_name=%sqlserver_name%,instance=%instance%:recovery_model" indicator="true"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=acc:${name}:g=Access Methods"/>
    <metrics name="mssql-access_c">
        <metric name="Full Scans/sec"/>
        <metric name="Range Scans/sec"/>
        <metric name="Probe Scans/sec"/>
        <metric name="Scan Point Revalidations/sec"/>
        <metric name="Workfiles Created/sec"/>
        <metric name="Worktables Created/sec"/>
        <metric name="Forwarded Records/sec"/>
        <metric name="Skipped Ghosted Records/sec"/>
        <metric name="Index Searches/sec"/>
        <metric name="FreeSpace Scans/sec"/>
        <metric name="FreeSpace Page Fetches/sec"/>
        <metric name="Pages Allocated/sec"/>
        <metric name="Extents Allocated/sec"/>
        <metric name="Mixed page allocations/sec"/>
        <metric name="Extent Deallocations/sec"/>
        <metric name="Page Deallocations/sec"/>
        <metric name="Page Splits/sec"/>
        <metric name="Table Lock Escalations/sec"/>
        <metric name="Dropped rowset cleanups/sec"/>
        <metric name="Dropped rowsets skipped/sec"/>
        <metric name="AU cleanups/sec"/>
        <metric name="AU cleanup batches/sec"/>
        <metric name="Failed AU cleanup batches/sec"/>
        <metric name="Used tree page cookie"/>
        <metric name="Failed tree page cookie"/>
        <metric name="Used leaf page cookie"/>
        <metric name="Failed leaf page cookie"/>
        <metric name="LobSS Provider Create Count"/>
        <metric name="LobSS Provider Destroy Count"/>
        <metric name="LobSS Provider Truncation Count"/>
        <metric name="LobHandle Create Count"/>
        <metric name="LobHandle Destroy Count"/>
        <metric name="By-reference Lob Create Count"/>
        <metric name="By-reference Lob Use Count"/>
        <metric name="Count Push Off Row"/>
        <metric name="Count Pull In Row"/>
        <metric name="Count Lob Readahead"/>
    </metrics>

	<filter name="template" value="pdh:Access Methods:${name}"/>
    <metrics name="mssql-access" include="mssql-access_c">
        <metric name="Worktables From Cache Ratio"/>
        <metric name="Deferred Dropped rowsets"/>
        <metric name="Deferred dropped AUs"/>
    </metrics>


    <filter name="template" value="pdh:Access Methods:${name}"/>
    <metrics name="mssql-access_2008">
        <metric name="Page compression attempts/sec" template="collector:sn=%service_name%,,t=acc:${name}:g=Access Methods"/>
        <metric name="Pages compressed/sec" template="collector:sn=%service_name%,,t=acc:${name}:g=Access Methods"/>
    </metrics>

    <filter name="template" value="pdh:Access Methods:${name}"/>
    <metrics name="mssql-access_2012">
        <metric name="InSysXact waits/sec" template="collector:sn=%service_name%,,t=acc:${name}:g=Access Methods"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=dbt,type=server:${alias}:g=Databases(_Total)"/>
    <metrics name="mssql-database-total_c">
        <metric name="Total Database Transactions/sec" alias="Transactions/sec" category="THROUGHPUT" indicator="true"/>
        <metric name="Total Database Log Flush Wait Time" alias="Log Flush Wait Time"/>
        <metric name="Total Database Repl. Trans. Rate" alias="Repl. Trans. Rate"/>
        <metric name="Total Database Repl. Pending Xacts" alias="Repl. Pending Xacts"/>
    </metrics>

    <filter name="template" value="pdh:Databases(_Total):${alias}"/>
    <metrics name="mssql-database-total">
        <include name="mssql-database-total_c"/>
        <metric name="Total Database Data File Size" alias="Data File(s) Size (KB)" indicator="true" units="KB"/>
        <metric name="Total Database Log File Size" alias="Log File(s) Size (KB)" indicator="true" units="KB"/>
        <metric name="Total Database Log File Used Size" alias="Log File(s) Used Size (KB)" units="KB"/>
        <metric name="Total Database Percent Log Used" alias="Percent Log Used" units="percent"/>
        <metric name="Total Database Active Transactions" alias="Active Transactions" category="THROUGHPUT" indicator="true"/>
        <metric name="Total Database Log Cache Hit Ratio" alias="Log Cache Hit Ratio"/>
        <metric name="Total Database Log Truncations" alias="Log Truncations"/>
        <metric name="Total Database Log Growths" alias="Log Growths"/>
        <metric name="Total Database Log Shrinks" alias="Log Shrinks"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=gen:${name}:g=General Statistics"/>
    <metrics name="mssql-general_c">
        <include name="mssql-database-total"/>
        <metric name="Temp Tables Creation Rate"/>
        <metric name="Logins/sec" indicator="true"/>
        <metric name="Logouts/sec" indicator="true"/>
        <metric name="Non-atomic yield rate"/>
        <metric name="Mars Deadlocks"/>
        <metric name="HTTP Authenticated Requests"/>
        <metric name="SOAP Empty Requests"/>
        <metric name="SOAP SQL Requests"/>
        <metric name="SOAP Method Invocations"/>
        <metric name="SOAP WSDL Requests"/>
        <metric name="SOAP Session Initiate Requests"/>
        <metric name="SOAP Session Terminate Requests"/>
        <metric name="SQL Trace IO Provider Lock Waits"/>
    </metrics>

    <filter name="template" value="pdh:General Statistics:${name}"/>
    <metrics name="mssql-general" include="mssql-general_c">
        <metric name="Active Temp Tables"/>
        <metric name="User Connections"/>
        <metric name="Logical Connections"/>
        <metric name="Transactions"/>
        <metric name="Processes blocked"/>
        <metric name="Temp Tables For Destruction"/>
        <metric name="Event Notifications Delayed Drop"/>
        <metric name="Trace Event Notification Queue"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=gen:${name}:g=General Statistics"/>
    <metrics name="mssql-general_2008">
        <metric name="Connection Reset/sec"/>
        <metric name="Tempdb recovery unit id"/>
        <metric name="Tempdb rowset id"/>
    </metrics>

    <filter name="template" value="pdh:Memory Manager:${name} (KB)"/>
    <metrics name="mssql-memory_kb">
        <metric name="Connection Memory" units="KB"/>
        <metric name="Granted Workspace Memory" units="KB"/>
        <metric name="Lock Memory" units="KB"/>
        <metric name="Maximum Workspace Memory" units="KB"/>
        <metric name="Optimizer Memory" units="KB"/>
        <metric name="SQL Cache Memory" units="KB"/>
        <metric name="Total Server Memory" units="KB" indicator="true"/>
    </metrics>

    <filter name="template" value="pdh:Memory Manager:${name}"/>
    <metrics name="mssql-memory">
        <include name="mssql-memory_kb"/>
        <metric name="Lock Blocks Allocated" />
        <metric name="Lock Owner Blocks Allocated" />
        <metric name="Lock Blocks" />
        <metric name="Lock Owner Blocks" />
        <metric name="Memory Grants Outstanding" />
        <metric name="Memory Grants Pending" />
    </metrics>

    <filter name="template" value="pdh:Memory Manager:${name} (KB)"/>
    <metrics name="mssql-memory-2012_kb">
        <metric name="Database Cache Memory" units="KB"/>
        <metric name="Free Memory" units="KB"/>
        <metric name="Reserved Server Memory" units="KB"/>
        <metric name="Stolen Server Memory" units="KB"/>
        <metric name="Log Pool Memory" units="KB"/>
        <metric name="Target Server Memory" units="KB" indicator="true"/>
    </metrics>

    <filter name="template" value="pdh:Memory Manager:${name}"/>
    <metrics name="mssql-memory-2012">
        <include name="mssql-memory-2012_kb"/>
        <metric name="External benefit of memory" />
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=stats:${name}:g=SQL Statistics"/>
    <metrics name="mssql-stats">
        <metric name="Batch Requests/sec" indicator="true"/>
        <metric name="SQL Compilations/sec" indicator="true"/>
        <metric name="SQL Re-Compilations/sec" indicator="true"/>
        <metric name="Forced Parameterizations/sec"/>
        <metric name="Auto-Param Attempts/sec"/>
        <metric name="Failed Auto-Params/sec"/>
        <metric name="Safe Auto-Params/sec"/>
        <metric name="Unsafe Auto-Params/sec"/>
        <metric name="SQL Attention rate"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=stats:${name}:g=SQL Statistics"/>
    <metrics name="mssql-stats_2008">
        <metric name="Guided plan executions/sec"/>
        <metric name="Misguided plan executions/sec"/>
    </metrics>

    <!-- XXX define Lock service?  breaks down into:
         Database, Extent, Key, Page, RID, Table
    -->

    <filter name="template" value="collector:sn=%service_name%,t=locks:${alias}:g=Locks(_Total)"/>
    <metrics name="mssql-locks_c">
        <metric name="Lock Wait Time" alias="Lock Wait Time (ms)" units="ms" indicator="true"/>
        <metric name="Locks Average Wait Time" alias="Average Wait Time (ms)" units="ms" indicator="true"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=locks:${name}:g=Locks(_Total)"/>
    <metrics name="mssql-locks" include="mssql-locks_c">
        <metric name="Lock Requests/Sec" indicator="true"/>
        <metric name="Lock Timeouts/Sec"/>
        <metric name="Number of Deadlocks/Sec" indicator="true"/>
        <metric name="Lock Waits/Sec" indicator="true"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=lat:${alias}:g=Latches"/>
    <metrics name="mssql-latches_c">
        <metric name="Latch Waits/sec" alias="Latch Waits/sec"/>
        <metric name="Average Latch Wait Time" alias="Average Latch Wait Time (ms)" units="ms"/>
        <metric name="Total Latch Wait Time" alias="Total Latch Wait Time (ms)" units="ms"/>
        <metric name="SuperLatch Promotions/sec" alias="SuperLatch Promotions/sec"/>
        <metric name="SuperLatch Demotions/sec" alias="SuperLatch Demotions/sec"/>
    </metrics>

    <filter name="template" value="pdh:Latches:${name}"/>
    <metrics name="mssql-latches" include="mssql-latches_c">
        <metric name="Number of SuperLatches"/>
    </metrics>

    <!-- XXX define Cache service?  breaks down into:
         Adhoc Sql Plans, Cursors, Execution Contexts,
         Misc. Normalized Trees, Prepared Sql Plans,
         Procedure Plans, Replication Procedure Plans,
         Trigger Plans.
    -->

    <!--metrics name="mssql-cache"/-->

    <metrics name="mssql-broker-activation">
        <metric name="Stored Procedures Invoked/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Broker Activation(_Total)" indicator="true"/>
    </metrics>

    <metrics name="mssql-agent-avail">
        <metric name="Availability" alias="Availability" template="service:Type=Availability,service_name=%service_name%:${alias}" indicator="true" category="AVAILABILITY"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=pf:${name}:g=process"/>
    <metrics name="mssql-process-formated">
        <metric name="% Processor Time" units="percent" indicator="true"/>
        <metric name="% User Time" units="percent"/>
        <metric name="% Privileged Time" units="percent"/>
        <metric name="Page Faults/sec"/>
        <metric name="IO Read Operations/sec"/>
        <metric name="IO Write Operations/sec"/>
        <metric name="IO Data Operations/sec"/>
        <metric name="IO Other Operations/sec"/>
        <metric name="IO Read Bytes/sec"/>
        <metric name="IO Write Bytes/sec"/>
        <metric name="IO Data Bytes/sec"/>
        <metric name="IO Other Bytes/sec"/>
    </metrics>

    <filter name="template" value="mssql:process:${name}"/>
    <metrics name="mssql-process">
        <include name="mssql-process-formated"/>
        <metric name="Virtual Bytes Peak"/>
        <metric name="Virtual Bytes"/>
        <metric name="Working Set Peak"/>
        <metric name="Working Set"/>
        <metric name="Page File Bytes Peak"/>
        <metric name="Page File Bytes"/>
        <metric name="Private Bytes"/>
        <metric name="Thread Count"/>
        <metric name="Priority Base"/>
        <metric name="Elapsed Time"/>
        <metric name="Pool Paged Bytes"/>
        <metric name="Pool Nonpaged Bytes"/>
        <metric name="Handle Count"/>
        <metric name="Working Set - Private"/>
    </metrics>

    <filter name="template" value="pdh:Jobs(_Total):${name}"/>
    <metrics name="mssql-agent-jobs">
        <metric name="Active jobs" indicator="true"/>
        <metric name="Successful jobs"/>
        <metric name="Failed jobs" indicator="true"/>
        <metric name="Job success rate"/>
        <metric name="Jobs activated/minute"/>
        <metric name="Queued jobs"/>
    </metrics>

    <filter name="template" value="pdh:Connection:${name}"/>
    <metrics name="MSOLAP_Connection">
        <metric name="Current connections"/>
        <metric name="Requests/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Connection"/>
        <metric name="Total requests"/>
        <metric name="Successes/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Connection"/>
        <metric name="Total successes"/>
        <metric name="Failures/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Connection"/>
        <metric name="Total failures" indicator="true"/>
        <metric name="Current user sessions"/>
    </metrics>

    <filter name="template" value="pdh:Locks:${name}"/>
    <metrics name="MSOLAP_Locks">
        <metric name="Current latch waits"/>
        <metric name="Latch waits/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Current locks"/>
        <metric name="Current lock waits"/>
        <metric name="Lock requests/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Unlock requests/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Lock grants/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Lock denials/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Lock waits/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Locks"/>
        <metric name="Total deadlocks detected"/>
    </metrics>

    <filter name="template" value="pdh:Threads:${name}"/>
    <metrics name="MSOLAP_Threads">
        <metric name="Short parsing idle threads"/>
        <metric name="Short parsing busy threads"/>
        <metric name="Short parsing job queue length"/>
        <metric name="Short parsing job rate" template="collector:sn=%service_name%,t=aux:${name}:g=Threads"/>
        <metric name="Long parsing idle threads"/>
        <metric name="Long parsing busy threads"/>
        <metric name="Long parsing job queue length"/>
        <metric name="Long parsing job rate" template="collector:sn=%service_name%,t=aux:${name}:g=Threads"/>
        <metric name="Query pool idle threads"/>
        <metric name="Query pool busy threads"/>
        <metric name="Query pool job queue length"/>
        <metric name="Query pool job rate" template="collector:sn=%service_name%,t=aux:${name}:g=Threads"/>
        <metric name="Processing pool job queue length"/>
        <metric name="Processing pool job rate" template="collector:sn=%service_name%,t=aux:${name}:g=Threads"/>
    </metrics>

    <filter name="template" value="pdh:Threads:${name}"/>
    <metrics name="MSOLAP_Threads_2005">
        <metric name="Processing pool idle threads"/>
        <metric name="Processing pool busy threads"/>
    </metrics>

    <filter name="template" value="pdh:Threads:${name}"/>
    <metrics name="MSOLAP_Threads_2012">
        <metric name="Processing pool idle non-I/O threads"/>
        <metric name="Processing pool busy non-I/O threads"/>
        <metric name="Processing pool idle I/O job threads"/>
        <metric name="Processing pool busy I/O job threads"/>
        <metric name="Processing pool I/O job queue length"/>
        <metric name="Processing pool I/O job completion rate" template="collector:sn=%service_name%,t=aux:${name}:g=Threads"/>
    </metrics>

    <filter name="template" value="pdh:Memory:${name}"/>
    <metrics name="MSOLAP_Memory">
        <metric name="Page Pool 64 Alloc KB"/>
        <metric name="Page Pool 64 Lookaside KB"/>
        <metric name="Page Pool 8 Alloc KB"/>
        <metric name="Page Pool 8 Lookaside KB"/>
        <metric name="Page Pool 1 Alloc KB"/>
        <metric name="Page Pool 1 Lookaside KB"/>
        <metric name="Cleaner Current Price"/>
        <metric name="Cleaner Balance/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Cleaner Memory shrunk KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Cleaner Memory shrinkable KB"/>
        <metric name="Cleaner Memory nonshrinkable KB"/>
        <metric name="Cleaner Memory KB"/>
        <metric name="Memory Usage KB"/>
        <metric name="Memory Limit Low KB"/>
        <metric name="Memory Limit High KB"/>
        <metric name="AggCacheKB"/>
        <metric name="Quota KB"/>
        <metric name="Quota Blocked"/>
        <metric name="Filestore KB"/>
        <metric name="Filestore Page Faults/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore Reads/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore KB Reads/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore Writes/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore KB Write/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore IO Errors/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore IO Errors"/>
        <metric name="Filestore Clock Pages Examined/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore Clock Pages HaveRef/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore Clock Pages Valid/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Filestore Memory Pinned KB" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="In-memory Dimension Property File KB"/>
        <metric name="In-memory Dimension Property File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Dimension Property File KB"/>
        <metric name="Dimension Property Files"/>
        <metric name="In-memory Dimension Index (Hash) File KB"/>
        <metric name="In-memory Dimension Index (Hash) File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Dimension Index (Hash) File KB"/>
        <metric name="Dimension Index (Hash) Files"/>
        <metric name="In-memory Dimension String File KB"/>
        <metric name="In-memory Dimension String File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Dimension String File KB"/>
        <metric name="Dimension String Files"/>
        <metric name="In-memory Map File KB"/>
        <metric name="In-memory Map File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Map File KB"/>
        <metric name="Map Files"/>
        <metric name="In-memory Aggregation Map File KB"/>
        <metric name="In-memory Aggregation Map File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Aggregation Map File KB"/>
        <metric name="Aggregation Map Files"/>
        <metric name="In-memory Fact Data File KB"/>
        <metric name="In-memory Fact Data File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Fact Data File KB"/>
        <metric name="Fact Data Files"/>
        <metric name="In-memory Fact String File KB"/>
        <metric name="In-memory Fact String File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Fact String File KB"/>
        <metric name="Fact String Files"/>
        <metric name="In-memory Fact Aggregation File KB"/>
        <metric name="In-memory Fact Aggregation File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Fact Aggregation File KB"/>
        <metric name="Fact Aggregation Files"/>
        <metric name="In-memory Other File KB"/>
        <metric name="In-memory Other File KB/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Memory"/>
        <metric name="Potential In-memory Other File KB"/>
        <metric name="Other Files"/>
    </metrics>

    <filter name="template" value="pdh:Memory:${name}"/>
    <metrics name="MSOLAP_Memory_2012">
        <metric name="VertiPaq Paged KB"/>
        <metric name="VertiPaq Nonpaged KB"/>
        <metric name="VertiPaq Memory-Mapped KB"/>
        <metric name="Memory Limit Hard KB"/>
        <metric name="Memory Limit VertiPaq KB"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=cache:${name}:g=Cache"/>
    <metrics name="MSOLAP_Cache_c">
        <metric name="Current KB"/>
        <metric name="KB added/sec"/>
        <metric name="Inserts/sec"/>
        <metric name="Evictions/sec"/>
        <metric name="Direct hits/sec"/>
        <metric name="Misses/sec"/>
        <metric name="Lookups/sec"/>
        <metric name="Direct hit ratio"/>
    </metrics>

    <filter name="template" value="pdh:Cache:${name}"/>
    <metrics name="MSOLAP_Cache" include="MSOLAP_Cache_c">
        <metric name="Current KB (Cache)"/>
        <metric name="Current entries"/>
        <metric name="Total inserts"/>
        <metric name="Total evictions"/>
        <metric name="Total direct hits"/>
        <metric name="Total misses"/>
        <metric name="Total lookups"/>
    </metrics>

    <filter name="template" value="pdh:Cache:${name}"/>
    <metrics name="MSOLAP_Cache_2008">
        <metric name="Total filtered iterator cache hits"/>
        <metric name="Total filtered iterator cache misses"/>
    </metrics>

    <filter name="template" value="pdh:MDX:${name}"/>
    <metrics name="MSOLAP_MDX">
        <metric name="Total Sonar subcubes"/>
        <metric name="Total cells calculated"/>
        <metric name="Total recomputes"/>
        <metric name="Total flat cache inserts"/>
        <metric name="Total NON EMPTY"/>
        <metric name="Total NON EMPTY for calculated members"/>
        <metric name="Total NON EMPTY unoptimized"/>
        <metric name="Total Autoexist"/>
        <metric name="Total EXISTING"/>
    </metrics>

    <filter name="template" value="pdh:Processing:${name}"/>
    <metrics name="MSOLAP_Processing">
        <metric name="Rows read/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Processing"/>
        <metric name="Total rows read"/>
        <metric name="Rows converted/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Processing"/>
        <metric name="Total rows converted"/>
        <metric name="Rows written/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Processing"/>
        <metric name="Total rows written"/>
    </metrics>

    <filter name="template" value="pdh:Proc Aggregations:${name}"/>
    <metrics name="MSOLAP_Proc Aggregations">
        <metric name="Current partitions (Proc Aggregations)"/>
        <metric name="Total partitions (Proc Aggregations)"/>
        <metric name="Memory size rows"/>
        <metric name="Memory size bytes"/>
        <metric name="Rows merged/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Proc Aggregations"/>
        <metric name="Rows created/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Proc Aggregations"/>
        <metric name="Temp file rows written/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Proc Aggregations"/>
        <metric name="Temp file bytes written/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Proc Aggregations"/>
    </metrics>

    <filter name="template" value="pdh:Proc Indexes:${name}"/>
    <metrics name="MSOLAP_Proc Indexes">
        <metric name="Current partitions (Proc Indexes)"/>
        <metric name="Total partitions (Proc Indexes)"/>
        <metric name="Rows/sec (Proc Indexes)" template="collector:sn=%service_name%,t=aux:${name}:g=Proc Indexes"/>
        <metric name="Total rows  (Proc Indexes)"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=seqc:${name}:g=Storage Engine Query"/>
    <metrics name="MSOLAP_Storage Engine Query_coll_2005">
        <metric name="Measure group queries/sec"/>
        <metric name="Dimension queries/sec"/>
        <metric name="Queries answered/sec"/>
        <metric name="Bytes sent/sec"/>
        <metric name="Rows sent/sec"/>
        <metric name="Queries from cache filtered/sec"/>
        <metric name="Queries from cache direct/sec"/>
        <metric name="Queries from file/sec"/>
        <metric name="Map reads/sec"/>
        <metric name="Map bytes/sec"/>
        <metric name="Data reads/sec"/>
        <metric name="Data bytes/sec"/>
        <metric name="Avg time/query" indicator="true"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=seqc:${name}:g=Storage Engine Query"/>
    <metrics name="MSOLAP_Storage Engine Query_coll">
        <metric name="Network round trips/sec"/>
        <metric name="Calculation cache lookups/sec"/>
        <metric name="Calculation cache hits/sec"/>
        <metric name="Persisted cache lookups/sec"/>
        <metric name="Persisted cache hits/sec"/>
        <metric name="Dimension cache lookups/sec"/>
        <metric name="Dimension cache hits/sec"/>
        <metric name="Flat cache lookups/sec"/>
        <metric name="Flat cache hits/sec"/>
        <metric name="Measure group cache lookups/sec"/>
        <metric name="Measure group cache hits/sec"/>
        <metric name="Aggregation lookups/sec"/>
        <metric name="Aggregation hits/sec"/>
    </metrics>

    <filter name="template" value="pdh:Storage Engine Query:${name}"/>
    <metrics name="MSOLAP_Storage Engine Query">
        <metric name="Current measure group queries"/>
        <metric name="Total measure group queries"/>
        <metric name="Current dimension queries"/>
        <metric name="Total dimension queries."/>
        <metric name="Total queries answered"/>
        <metric name="Total queries from cache filtered"/>
        <metric name="Total queries from cache direct"/>
        <metric name="Total queries from file"/>
        <metric name="Total network round trips"/>
    </metrics>

    <filter name="template" value="pdh:Data Mining Model Processing:${name}"/>
    <metrics name="MSOLAP_Data Mining Model Processing">
        <metric name="Cases/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Data Mining Model Processing"/>
        <metric name="Current models processing"/>
    </metrics>

    <filter name="template" value="pdh:Data Mining Prediction:${name}"/>
    <metrics name="MSOLAP_Data Mining Prediction">
        <metric name="Predictions/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Data Mining Prediction"/>
        <metric name="Rows/sec (Data Mining Prediction)" template="collector:sn=%service_name%,t=aux:${name}:g=Data Mining Prediction"/>
        <metric name="Concurrent DM queries"/>
        <metric name="Queries/sec" template="collector:sn=%service_name%,t=aux:${name}:g=Data Mining Prediction"/>
        <metric name="Total Queries"/>
        <metric name="Total Rows  (Data Mining Prediction)"/>
        <metric name="Total Predictions"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=pc:${name}:g=Proactive Caching"/>
    <metrics name="MsSQL 2012 MSOLAP_Proactive Caching">
        <metric name="Notifications/sec"/>
        <metric name="Processing Cancellations/sec"/>
        <metric name="Proactive Caching Begin/sec"/>
        <metric name="Proactive Caching Completion/sec"/>
    </metrics>

    <filter name="template" value="pdh:Service:${name}"/>
    <metrics name="ReportServer Service">
        <metric name="Availability" alias="Availability" template="service:Type=Availability,service_name=%service_name%:${alias}" indicator="true" category="AVAILABILITY"/>
        <metric name="Requests/sec"/>
        <metric name="Requests Total"/>
        <metric name="Errors/sec"/>
        <metric name="Errors Total"/>
        <metric name="Bytes Sent/sec"/>
        <metric name="Bytes Sent Total"/>
        <metric name="Bytes Received/sec"/>
        <metric name="Bytes Received Total"/>
        <metric name="Active Connections"/>
        <metric name="Logon Attempts/sec"/>
        <metric name="Logon Attempts Total"/>
        <metric name="Logon Successes/sec"/>
        <metric name="Logon Successes Total"/>
        <metric name="Requests Not Authorized"/>
        <metric name="Requests Rejected"/>
        <metric name="Requests Disconnected"/>
        <metric name="Requests Executing"/>
        <metric name="Memory Pressure State"/>
        <metric name="Memory Shrink Notifications/sec"/>
        <metric name="Memory Shrink Amount"/>
        <metric name="Tasks Queued"/>
    </metrics>

    <filter name="template" value="collector:sn=%service_name%,t=ReportServer:${name}:g=%MSRS%(%instance%),format=2"/>
    <metrics name="MsSQL 2005 Report Server_c">
        <metric name="Cache Hits/Sec (Semantic Models)"/>
        <metric name="Cache Hits/Sec"/>
        <metric name="Cache Misses/Sec (Semantic Models)"/>
        <metric name="Cache Misses/Sec"/>
        <metric name="Delivers/Sec"/>
        <metric name="Events/Sec"/>
        <metric name="First Session Requests/Sec"/>
        <metric name="Memory Cache Hits/Sec"/>
        <metric name="Memory Cache Miss/Sec"/>
        <metric name="Next Session Requests/Sec"/>
        <metric name="Reports Executed/Sec"/>
        <metric name="Requests/Sec"/>
        <metric name="Snapshot Updates/Sec"/>
        <metric name="Cache Flushes/Sec"/>
    </metrics>

    <filter name="template" value="pdh2:%MSRS%(%instance%):${name}"/>
    <metrics name="MsSQL 2005 Report Server">
        <include name="MsSQL 2005 Report Server_c"/>
        <metric name="Availability" alias="Availability" template="service:Type=Availability,service_name=%service_name%:${alias}" indicator="true" category="AVAILABILITY"/>
        <metric name="Report Requests"/>
        <metric name="Total Reports Executed"/>
        <metric name="Total Processing Failures" indicator="true"/>
        <metric name="Total Rejected Threads" indicator="true"/>
        <metric name="Active Sessions"/>
        <metric name="Total Cache Hits"/>
        <metric name="Total Cache Misses"/>
        <metric name="Total Requests"/>
        <metric name="Total Memory Cache Hits"/>
        <metric name="Total Memory Cache Misses"/>
        <metric name="Total Cache Hits (Semantic Models)"/>
        <metric name="Total Cache Misses (Semantic Models)"/>
        <metric name="Total App Domain Recycles"/>
        <metric name="Total Deliveries"/>
        <metric name="Total Events"/>
        <metric name="Total Snapshot Updates"/>
        <metric name="Total Cache Flushes"/>
    </metrics>

    <metrics name="MSOLAP">
		<include name="MSOLAP_Connection"/>
		<include name="MSOLAP_Locks"/>
        <include name="MSOLAP_MDX"/>
        <include name="MSOLAP_Processing"/>
        <include name="MSOLAP_Proc Aggregations"/>
        <include name="MSOLAP_Proc Indexes"/>
        <include name="MSOLAP_Storage Engine Query"/>
        <include name="MSOLAP_Storage Engine Query_coll_2005"/>
        <include name="MSOLAP_Data Mining Model Processing"/>
        <include name="MSOLAP_Data Mining Prediction"/>
        <include name="MSOLAP_Cache"/>
		<include name="MSOLAP_Cache_2008"/>
      	<include name="MSOLAP_Storage Engine Query_coll"/>
     	<include name="MsSQL 2012 MSOLAP_Proactive Caching"/>        		
      	<include name="MSOLAP_Threads"/>        		
      	<include name="MSOLAP_Threads_2005"/>
        <include name="MSOLAP_Threads_2012"/>
		<include name="MSOLAP_Memory"/>
        <include name="MSOLAP_Memory_2012"/>
    </metrics>

    <server name="MSSQL" platforms="Win32" roaming="true">
        <plugin type="measurement" class="MsSQLMeasurementPlugin"/>
        <plugin type="autoinventory" class="MsSQLDetector"/>
        <plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
        <plugin type="collector" class="MsSQLCollector"/>

        <actions include="start,stop,restart"/>

        <metrics>
            <include name="mssql-avail"/>
            <include name="mssql-process"/>
            <include name="mssql-access"/>
            <include name="mssql-general"/>
            <include name="mssql-memory"/>
            <include name="mssql-stats"/>
            <include name="mssql-locks"/>
            <include name="mssql-latches"/>
            <include name="Buffer-Manager"/>
            <include name="mssql-broker-activation"/>
            <!-- MsSQL 2008 more metrics -->
            <include name="mssql-access_2008"/>
            <include name="mssql-general_2008"/>
            <include name="mssql-stats_2008"/>
            <!-- MsSQL 2012 more metrics -->
            <include name="mssql-access_2012"/>
            <include name="mssql-memory-2012"/>
            <include name="Buffer-Manager_2012"/>
        </metrics>

        <config>
            <option name="service_name" description="Service Name" default="MSSQLSERVER"/>
            <option name="sqlserver_name" description="Server Name" default="localhost"/>

            <option name="version" description="Version" optional="true"/>
            <option name="mssql-cluster-name" description="ms-cluster name" optional="true"/>
            <option name="instance-name" description="mssql instance name" optional="true"/>
            <option name="original-platform-name" description="platform name" optional="true"/>
            <option name="virtual-platform-name" description="ms-cluster virtual host name for this mssql-instance" optional="true"/>
            <option name="cluster-nodes" description="ms-cluster all nodes" optional="true"/>
            <option name="active" description="true if this server is the active node in cluster" optional="true"/>
        </config>

        <property name="versions" value="2000,2005,2008,2008R2,2012,2014"/>
        <property name="2000.mssql.version" value="8"/>
        <property name="2000.mssql.version.file" value="sqlctr80.dll"/>
        <property name="2005.mssql.version" value="9"/>
        <property name="2005.mssql.version.file" value="sqlsvc90.dll"/>
        <property name="2008.mssql.version.file" value="sqlsvc.dll"/>
        <property name="2008.regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL10.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="2008.version" value="10.0.\d*\.\d*"/>
        <property name="2008.MS_CLUSTER_DISCOVERY" value="true"/>
        <property name="2008R2.mssql.version.file" value="sqlsvc.dll"/>
        <property name="2008R2.regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL10_50.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="2008R2.version" value="10.5.\d*\.\d*"/>
        <property name="2008R2.MS_CLUSTER_DISCOVERY" value="true"/>
        <property name="2012.mssql.version.file" value="sqlsvc.dll"/>
        <property name="2012.regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL11.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="2012.version" value="11.0.\d*\.\d*"/>
        <property name="2012.MS_CLUSTER_DISCOVERY" value="true"/>
        <property name="2014.mssql.version.file" value="sqlsvc.dll"/>
        <property name="2014.regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL12.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="2014.version" value="12.0.\d*\.\d*"/>
        <property name="2014.MS_CLUSTER_DISCOVERY" value="true"/>

        <properties>
            <property name="version" description="Version"/>
        </properties>

        <service name="Agent" model="standard">
            <plugin type="measurement" class="MsSQLMeasurementPlugin"/>
            <plugin type="collector" class="MsSQLCollector"/>
            <metrics>
                <include name="mssql-agent-avail"/>
                <include name="mssql-agent-jobs"/>
            </metrics>
            <config>
                <option name="service_name" description="Service Name" default="SQLSERVERAGENT"/>
                <option name="pref_prefix" description="Performace counters prefix"/>
                <option name="instance" description="MSSQL Instance Name"/>
                <option name="active" description="Active" default="true"/>
            </config>
        </service>

        <service name="Reporting Services" model="standard">
            <plugin type="measurement" class="MsSQLMeasurementPlugin"/>
            <plugin type="collector" class="MsSQLCollector"/>
            <config>
                <option name="service_name" description="Service Name"/>
                <option name="pref_prefix" description="Performace counters prefix"/>
                <option name="MSRS" description="MSRS prefix"/>
                <option name="instance" description="MSSQL Instance Name"/>
                <option name="active" description="Active" default="true"/>
            </config>
            <metrics>
                <include name="MsSQL 2005 Report Server"/>
            </metrics>
        </service>

        <service name="Analysis Services" model="standard">
            <plugin type="measurement" class="MsSQLMeasurementPlugin"/>
            <plugin type="collector" class="MsSQLCollector"/>
            <config>
                <option name="service_name" description="Service Name"/>
                <option name="pref_prefix" description="Performace counters prefix"/>
                <option name="instance" description="MSSQL Instance name"/>
                <option name="active" description="Active" default="true"/>
            </config>
            <metrics>
        		<metric name="Availability" alias="Availability" template="service:Type=Availability,service_name=%service_name%:${alias}" indicator="true" category="AVAILABILITY"/>
                <include name="MSOLAP"/>
            </metrics>
        </service>

        <service name="Database">
            <plugin type="measurement" class="MsSQLMeasurementPlugin"/>
            <plugin type="collector" class="MsSQLCollector"/>
            <config>
                <option name="db.name" description="Database name" default="Northwind"/>
                <option name="instance" description="MSSQL Instance name"/>
                <option name="disk" description="DataBase file drive" default="c:"/>
                <option name="master.file" description="Master DataBase file" default="c:"/>
                <option name="active" description="Active" default="true"/>
            </config>
            <metrics>
				<include name="mssql-database"/>
        		<metric name="Database Free Percent" units="percent" template="dfp:v=2005,sqlserver_name=%sqlserver_name%,instance=%instance%:%db.name%" indicator="true"/>				
            </metrics>
        </service>
    </server>
</plugin>
